<!DOCTYPE html>
<html
  lang="es"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tu Perfil</title>
    <!-- Enlaces a hojas de estilo -->
    <link rel="stylesheet" th:href="@{/styles/user_profile.css}" />
    <link rel="stylesheet" th:href="@{/styles/navbar.css}" />
    <link rel="stylesheet" th:href="@{/styles/loader.css}" />
    <!-- Iconos de Boxicons -->
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
    <!-- Fuente de Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" th:href="@{/styles/avatars.css}" />
    <script th:src="@{/js/loader-init.js}"></script>
  </head>
  <body>
    <!-- Pantalla de carga -->
    <div th:replace="~{fragments :: loadingScreen}"></div>
    <!-- Contenedor principal con diseño de grid -->
    <main class="grid-container">
      <!-- Columna Principal - Contiene los formularios de edición -->
      <div class="main-column">
        <!-- Tarjeta 1: Información Personal -->
        <section class="card">
          <div class="card-header"><h1>Información Personal</h1></div>
          <div class="card-body">
            <!-- Mensajes de alerta para información personal -->
            <div
              th:if="${exitoInfo}"
              class="alert alert-success"
              th:text="${exitoInfo}"
            ></div>
            <div
              th:if="${errorInfo}"
              class="alert alert-error"
              th:text="${errorInfo}"
            ></div>
            <!-- Formulario para actualizar información personal -->
            <form
              class="profile-form"
              th:action="@{/perfil/actualizar}"
              method="post"
            >
              <!-- Token CSRF para seguridad -->
              <input
                type="hidden"
                th:name="${_csrf.parameterName}"
                th:value="${_csrf.token}"
              />
              <div class="form-group">
                <label for="usuario">Nombre de Usuario</label>
                <input
                  type="text"
                  id="usuario"
                  name="usuario"
                  th:value="${usuarioLogueado.nombreUsuario}"
                  required
                />
              </div>
              <div class="form-group">
                <label for="correo">Correo Electrónico</label>
                <input
                  type="email"
                  id="correo"
                  name="correo"
                  th:value="${usuarioLogueado.correoElectronico}"
                  required
                />
              </div>
              <div class="form-group">
                <label for="ciudad">Ciudad (para el clima)</label>
                <input
                  type="text"
                  id="ciudad"
                  name="ciudad"
                  th:value="${usuarioLogueado.ciudad}"
                  placeholder="Ej: Curico,CL"
                />
              </div>
              <button type="submit" class="btn btn-primary">
                Guardar Cambios
              </button>
            </form>
          </div>
        </section>

        <!-- Tarjeta 2: Cambiar Contraseña -->
        <section class="card">
          <div class="card-header"><h1>Cambiar Contraseña</h1></div>
          <div class="card-body">
            <!-- Mensajes de alerta para cambio de contraseña -->
            <div
              th:if="${exitoPassword}"
              class="alert alert-success"
              th:text="${exitoPassword}"
            ></div>
            <div
              th:if="${errorPassword}"
              class="alert alert-error"
              th:text="${errorPassword}"
            ></div>

            <!-- Formulario para cambiar contraseña -->
            <form
              class="profile-form"
              th:action="@{/perfil/cambiar-contrasena}"
              method="post"
            >
              <!-- Token CSRF para seguridad -->
              <input
                type="hidden"
                th:name="${_csrf.parameterName}"
                th:value="${_csrf.token}"
              />
              <div class="form-group">
                <label for="contrasenaActual">Contraseña Actual</label>
                <input
                  type="password"
                  id="contrasenaActual"
                  name="contrasenaActual"
                  required
                />
              </div>
              <div class="form-group">
                <label for="contrasenaNueva">Nueva Contraseña</label>
                <input
                  type="password"
                  id="contrasenaNueva"
                  name="contrasenaNueva"
                  required
                />
              </div>
              <div class="form-group">
                <label for="contrasenaRepetida"
                  >Confirmar Nueva Contraseña</label
                >
                <input
                  type="password"
                  id="contrasenaRepetida"
                  name="contrasenaRepetida"
                  required
                />
              </div>
              <button type="submit" class="btn btn-primary">
                Actualizar Contraseña
              </button>
            </form>
          </div>
        </section>
      </div>

      <!-- Columna Lateral - Contiene logros y acciones de cuenta -->
      <div class="sidebar-column">
        <aside class="card avatar-management-card">
          <div class="card-header">
            <h2>Mi Avatar</h2>
          </div>
          <div class="card-body avatar-section-body">
            
            <div class="avatar-wrapper">
                <div class="auto-avatar" 
                    style="width: 150px; height: 150px; font-size: 3.5rem;"
                    th:data-nombre="${usuarioLogueado.nombreUsuario}"
                    th:data-url="${usuarioLogueado.avatarUrl}">
                </div>
            </div>

            <div class="avatar-actions">
                
                <form th:action="@{/perfil/avatar/subir}" method="post" enctype="multipart/form-data">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    
                    <input type="file" name="archivo" id="avatarInput" class="input-file-hidden" accept="image/png, image/jpeg, image/jpg" onchange="this.form.submit()">
                    
                    <label for="avatarInput" class="btn btn-primary btn-upload">
                        <i class='bx bx-camera'></i> Cambiar Avatar
                    </label>
                </form>

                <form th:action="@{/perfil/avatar/eliminar}" method="post" 
                      th:if="${usuarioLogueado.avatarUrl != null}">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    
                    <button type="submit" class="btn btn-danger-outline btn-delete-avatar" onclick="return confirm('¿Seguro que quieres borrar tu foto? Volverás a tener las iniciales de color.');">
                        <i class='bx bx-trash'></i> Eliminar Foto
                    </button>
                </form>
            </div>

          </div>
        </aside>
        <!-- Tarjeta de Logros -->
        <aside class="card">
          <div class="card-header">
            <h2 th:text="|Logros (${logrosObtenidosCount}/${logrosTotalesCount})|">
              Logros
            </h2>
          </div>
          <div class="card-body">
            <!-- Grid de logros -->
            <div class="achievements-grid">
              <div
                th:each="logro : ${allAchievements}"
                class="achievement-item"
                th:classappend="${!unlockedAchievementsIds.contains(logro.getId()) ? 'locked' : ''}"
                th:data-title="${logro.getNombre()}"
                th:data-desc="${logro.getDescripcion()}"
                th:data-exp="${logro.getPuntosRecompensa()}"
                th:data-unlocked="${unlockedAchievementsIds.contains(logro.getId())}"
                
                th:data-date="${unlockedMap.containsKey(logro.getId()) ? 
                              #temporals.format(unlockedMap.get(logro.getId()).fechaCompletada, 'dd/MM/yyyy') : 
                              null}"
              >
                <img
                  th:if="${logro.imagenUrl != null and !logro.imagenUrl.isEmpty()}"
                  th:src="${logro.imagenUrl}"
                  th:alt="${logro.getNombre()}"
                  style="width: 100%; height: 100%; object-fit: cover;"
                />
                
                <i
                  th:unless="${logro.imagenUrl != null and !logro.imagenUrl.isEmpty()}"
                  class='bx bxs-star'
                  style="font-size: 36px;"
                  th:styleappend="${unlockedAchievementsIds.contains(logro.getId()) ? 'color: var(--color-principal);' : ''}"
                ></i>

              </div> 
            </div>
            <!-- Tooltip que se mostrará al pasar el mouse sobre los logros -->
            <div id="achievement-tooltip">
              <div id="tooltip-title" class="tooltip-title"></div>
              <div id="tooltip-desc" class="tooltip-description"></div>
              <div id="tooltip-exp" class="tooltip-exp"></div>
              <div id="tooltip-date" class="tooltip-date"></div>
            </div>
          </div>
        </aside>

        <!-- Tarjeta: Acciones de la Cuenta -->
        <aside class="card">
          <div class="card-header"><h2>Acciones de la Cuenta</h2></div>
          <div
            class="card-body"
            style="display: flex; flex-direction: column; gap: 15px"
          >
            <!-- Formulario para cerrar sesión -->
            <form th:action="@{/logout}" method="post">
              <input
                type="hidden"
                th:name="${_csrf.parameterName}"
                th:value="${_csrf.token}"
              />
              <button
                type="submit"
                class="btn btn-secondary"
                onclick="return confirm('¿Estás seguro de que quieres cerrar la sesión?');"
              >
                Cerrar Sesión
              </button>
            </form>
            <!-- Formulario para eliminar cuenta -->
            <form th:action="@{/perfil/borrar-cuenta}" method="post">
              <input
                type="hidden"
                th:name="${_csrf.parameterName}"
                th:value="${_csrf.token}"
              />
              <button
                type="submit"
                class="btn btn-danger-outline"
                onclick="return confirm('¡ATENCIÓN! Esta acción es permanente. ¿Seguro que quieres eliminar tu cuenta?');"
              >
                Eliminar Cuenta
              </button>
            </form>
          </div>
        </aside>
      </div>
    </main>

    <!-- Inclusión de la barra de navegación -->
    <div th:replace="~{fragments :: navbar}"></div>

    <!-- Tooltip que se mostrará al pasar el mouse sobre los logros -->
    <div id="achievement-tooltip">
      <div id="tooltip-title" class="tooltip-title"></div>
      <div id="tooltip-desc" class="tooltip-description"></div>
      <div id="tooltip-exp" class="tooltip-exp"></div>
      <div id="tooltip-date" class="tooltip-date"></div>
    </div>
    
    <!-- Pantalla de carga -->
    <script th:src="@{/js/loader-main.js}"></script>
    <!-- SCRIPT PARA EL TOOLTIP INTELIGENTE -->
    <script th:src="@{/js/user_profile.js}"></script>
    <script th:src="@{/js/avatar-core.js}"></script>
  </body>
</html>
