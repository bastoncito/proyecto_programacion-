<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel de Administrador</title>

    <!-- Hojas de estilo principales para este panel -->
    <link rel="stylesheet" th:href="@{/styles/admin.css}" />
    <!-- Iconos de Boxicons, una librería externa muy útil -->
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
    <!-- Estilos para la animación de carga -->
    <link rel="stylesheet" th:href="@{/styles/loader.css}" />
    <!-- Fuentes personalizadas de Google Fonts para un mejor diseño -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script th:src="@{/js/loader-init.js}"></script>
  </head>
  <body>
    <!-- 
      Incluimos el fragmento de la pantalla de carga.
      Esto mantiene el código de la animación en un archivo separado y reutilizable.
    -->
    <div th:replace="~{fragments :: loadingScreen}"></div>

    <!-- Contenedor principal del layout del panel de administración -->
    <main class="admin-container">
      <!-- =================================================================== -->
      <!-- 1. BARRA LATERAL IZQUIERDA (SOLO VISIBLE EN ESCRITORIO)             -->
      <!-- =================================================================== -->
      <div class="container-task-bar">
        <div class="logo-placeholder">
          <img
            th:src="@{/images/logo_negro.png}"
            style="width: 180px; height: auto"
            alt="Logo"
          />
        </div>
        <ul>
          <!-- Enlaces de navegación que pasan el parámetro 'vista' para cambiar el contenido -->
          <li><a th:href="@{/admin(vista='usuarios')}"><i class="bx bxs-group"></i> Usuarios</a></li>
          <li><a th:href="@{/admin(vista='tareas')}"><i class="bx bx-task"></i> Tareas</a></li>
          <li><a th:href="@{/admin(vista='top')}"r><i class="bx bxs-bar-chart-alt-2"></i> Top</a></li>
          <li><a th:href="@{/admin(vista='logros')}"><i class="bx bxs-trophy"></i> Logros</a></li>
        </ul>
        <div></div>
        <!-- Div vacío para ayudar con el layout flexbox -->
      </div>

      <!-- =================================================================== -->
      <!-- 2. CONTENIDO PRINCIPAL (DERECHA EN ESCRITORIO, TODO EN MÓVIL)      -->
      <!-- =================================================================== -->
      <div class="main-content">
        <!-- Mensaje de éxito (Flash Attribute): solo se muestra si el controlador envía un atributo "success" -->
        <div th:if="${success}" class="flash-success">
          <i class="bx bx-check-circle"></i><span th:text="${success}"></span>
        </div>

        <!-- Tarjeta de información del administrador logueado -->
        <div class="container-info">
          <div class="info-section" th:if="${usuarioActual != null}">
            <div class="user-info">
              <p><strong th:text="${usuarioActual.nombreUsuario}"></strong></p>
              <p th:text="${usuarioActual.correoElectronico}"></p>
              <p th:text="${usuarioActual.rol}"></p>
            </div>
            <div class="user-avatar"></div>
            <!-- Placeholder para una imagen de perfil -->
          </div>
        </div>

        <!-- Navegación por pestañas (SOLO VISIBLE EN MÓVIL) -->
        <div class="admin-tabs">
          <!-- 
                  'th:classappend' añade la clase 'active' dinámicamente si la 'vistaActual'
                  coincide con la pestaña, resaltándola visualmente.
                -->
          <a
            th:href="@{/admin(vista='usuarios')}"
            th:classappend="${vistaActual == 'usuarios' ? 'active' : ''}"
            >Usuarios</a
          >
          <a
            th:href="@{/admin(vista='tareas')}"
            th:classappend="${vistaActual == 'tareas' ? 'active' : ''}"
            >Tareas</a
          >
          <a
            th:href="@{/admin(vista='top')}"
            th:classappend="${vistaActual == 'top' ? 'active' : ''}"
            >Top</a
          >
          <a
          th:href="@{/admin(vista='logros')}"
          th:classappend="${vistaActual == 'logros' ? 'active' : ''}"
          >Logros</a
          >
        </div>

        <!-- Área de trabajo principal donde se renderiza el contenido de cada vista -->
        <div class="container-work">
          <!-- Renderiza la sección correspondiente a la 'vistaActual' -->
          <div th:switch="${vistaActual}">
            <!-- === VISTA DE USUARIOS === -->
            <div th:case="'usuarios'">
              <div class="section-title">Usuarios</div>
              <div class="section-line"></div>
              <div class="list-box">
                <div class="list-box-content">
                  <!-- Cabecera de la tabla de usuarios -->
                  <div class="param-bar">
                    <div class="user-cell">Nombre</div>
                    <div class="user-cell">Correo</div>
                    <div class="user-cell">Rol</div>
                    <div class="user-cell">Nivel</div>
                    <div class="user-cell">Acciones</div>
                  </div>
                  <!-- 
                                  'th:each' itera sobre la lista 'listaDeUsuarios' que viene del controlador,
                                  creando una fila 'user-row' por cada usuario.
                                -->
                  <div class="user-row" th:each="usuario : ${listaDeUsuarios}">
                    <div
                      class="user-cell"
                      th:text="${usuario.nombreUsuario}"
                    ></div>
                    <div
                      class="user-cell"
                      th:text="${usuario.correoElectronico}"
                    ></div>
                    <div class="user-cell" th:text="${usuario.rol}"></div>
                    <div
                      class="user-cell"
                      th:text="${usuario.nivelExperiencia}"
                    ></div>
                    <div class="user-cell actions">
                      <!-- 
                                          Lógica de seguridad en la vista:
                                          Los botones de Editar y Eliminar solo se renderizan si el servicio de seguridad
                                          lo permite, comparando los roles del admin logueado y del usuario en la fila.
                                        -->
                      <a
                        th:if="${seguridadService.puedeEditar(usuarioActual, usuario)}"
                        th:href="@{/admin(editarUsuarioCorreo=${usuario.correoElectronico}, vista='usuarios')}"
                        class="btn-edit"
                        >Editar</a
                      >
                      <a
                        th:if="${seguridadService.puedeEliminar(usuarioActual, usuario)}"
                        th:href="@{/admin/eliminar(correo=${usuario.correoElectronico})}"
                        class="btn-delete" 
                        onclick="return confirm('¿Estás seguro de que quieres eliminar a este usuario?');"
                        >Eliminar</a
                      >
                    </div>
                  </div>
                  <!-- Mensaje que se muestra si la lista de usuarios está vacía -->
                  <div
                    th:if="${listaDeUsuarios.isEmpty()}"
                    class="empty-list-message"
                    style="grid-column: 1 / -1"
                  >
                    <p>No hay usuarios registrados.</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- === VISTA DE TAREAS (cargada desde un fragmento) === -->
            <div th:case="'tareas'">
              <div
                th:replace="~{tareas-fragment :: contenidoTareasMaestroDetalle}"
              ></div>
            </div>

            <!-- === VISTA DE TOP (cargada desde un fragmento) === -->
            <div th:case="'top'">
              <div
                th:replace="~{top-fragment :: contenidoTopLeaderboard}"
              ></div>
            </div>

            <!-- === VISTA DE LOGROS (cargada desde un fragmento) === -->
            <div th:case="'logros'">
              <div
                th:replace="~{logros-fragment :: contenidoLogros}"
              ></div>
            </div>

          </div>
        </div>
      </div>
    </main>

    <!-- =================================================================== -->
    <!-- 3. SECCIÓN DE MODALES (VENTANAS EMERGENTES)                         -->
    <!-- =================================================================== -->

    <!-- Modal para Editar Usuario -->
    <div class="modal-overlay" th:if="${usuarioParaEditar != null}">
      <div class="modal-content">
        <h2>Editar Usuario</h2>
        <div class="section-line"></div>
        <form th:action="@{/admin/guardar}" method="post" class="edit-form">
          <input
            type="hidden"
            th:name="${_csrf.parameterName}"
            th:value="${_csrf.token}"
          />
          <input
            type="hidden"
            name="correoElectronicoOriginal"
            th:value="${usuarioParaEditar.correoElectronico}"
          />

          <div class="form-group">
            <label for="nombreUsuario">Nombre de Usuario</label>
            <input
              type="text"
              id="nombreUsuario"
              name="nombreUsuario"
              th:value="${usuarioParaEditar.nombreUsuario}"
              required
            />
          </div>
          <div class="form-group">
            <label for="nuevoCorreo">Correo Electrónico</label>
            <input
              type="email"
              id="nuevoCorreo"
              name="nuevoCorreo"
              th:value="${usuarioParaEditar.correoElectronico}"
              required
            />
          </div>
          <div class="form-group">
            <label for="rol">Rol del Usuario</label>
            <select id="rol" name="rol" required size="4">
              <option
                th:each="rolValue : ${rolesDisponibles}"
                th:value="${rolValue}"
                th:text="${rolValue}"
                th:selected="${rolValue == usuarioParaEditar.rol}"
              ></option>
            </select>
          </div>
          <div
            class="section-line"
            style="margin-top: 15px; margin-bottom: 15px"
          ></div>
          <div class="form-group">
            <label for="nuevaContrasena">Nueva Contrasena (Opcional)</label>
            <!-- 'type="password"' para que el texto no sea visible. -->
            <input
              type="password"
              id="nuevaContrasena"
              name="nuevaContrasena"
              placeholder="Dejar en blanco para no cambiar"
            />
          </div>
          <div class="form-group">
            <label for="confirmarContrasena">Confirmar Nueva Contrasena</label>
            <input
              type="password"
              id="confirmarContrasena"
              name="confirmarContrasena"
              placeholder="Repetir la nueva contrasena"
            />
          </div>
          <div th:if="${error}" class="alert-error" th:text="${error}"></div>
          <div class="form-actions">
            <a th:href="@{/admin}" class="btn-cancel">Cerrar</a>
            <button type="submit" class="btn-save">Guardar Cambios</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal para Editar Tarea -->
    <div class="modal-overlay" th:if="${tareaParaEditar != null}">
      <div class="modal-content">
        <h2>
          Editar Tarea de
          <span th:text="${usuarioDeLaTarea.nombreUsuario}"></span>
        </h2>
        <div class="section-line"></div>
        <form th:action="@{/admin/tareas/guardar}" method="post" class="edit-form">
          <input
            type="hidden"
            th:name="${_csrf.parameterName}"
            th:value="${_csrf.token}"
          />
          <input
            type="hidden"
            name="correoUsuario"
            th:value="${usuarioDeLaTarea.correoElectronico}"
          />
          <input
            type="hidden"
            name="nombreOriginal"
            th:value="${tareaParaEditar.nombre}"
          />
          <div class="form-group">
            <label for="editNombreTarea">Nombre</label>
            <input
              type="text"
              id="editNombreTarea"
              name="nombre"
              th:value="${tareaParaEditar.nombre}"
              required
            />
          </div>
          <div class="form-group">
            <label for="editDescripcionTarea">Descripción</label>
            <input
              type="text"
              id="editDescripcionTarea"
              name="descripcion"
              th:value="${tareaParaEditar.descripcion}"
              required
            />
          </div>
          <div class="form-group">
            <label for="editDificultadTarea">Dificultad</label>
            <select
              id="editDificultadTarea"
              name="dificultad"
              required
              size="4"
            >
              <option
                value="Muy fácil"
                th:selected="${tareaParaEditar.exp == 10}"
              >
                Muy fácil
              </option>
              <option value="Fácil" th:selected="${tareaParaEditar.exp == 25}">
                Fácil
              </option>
              <option value="Medio" th:selected="${tareaParaEditar.exp == 50}">
                Intermedio
              </option>
              <option
                value="Difícil"
                th:selected="${tareaParaEditar.exp == 100}"
              >
                Difícil
              </option>
              <option
                value="Muy difícil"
                th:selected="${tareaParaEditar.exp == 150}"
              >
                Muy difícil
              </option>
            </select>
          </div>
          <div th:if="${error}" class="alert-error" th:text="${error}"></div>
          <div class="form-actions">
            <a
              th:href="@{/admin(vista='tareas', correo=${usuarioDeLaTarea.correoElectronico})}"
              class="btn-cancel"
              >Cancelar</a
            >
            <button type="submit" class="btn-save">Guardar Cambios</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal para Crear Nuevo Usuario -->
    <div class="modal-overlay" th:if="${mostrarModalCrear}">
      <div class="modal-content">
        <h2>Crear Nuevo Usuario</h2>
        <div class="section-line"></div>
        <form th:action="@{/admin/crear}" method="post" class="edit-form">
          <input
            type="hidden"
            th:name="${_csrf.parameterName}"
            th:value="${_csrf.token}"
          />
          <div class="form-group">
            <label for="createNombreUsuario">Nombre de Usuario</label>
            <input
              type="text"
              id="createNombreUsuario"
              name="nombreUsuario"
              required
            />
          </div>
          <div class="form-group">
            <label for="createNuevoCorreo">Correo Electrónico</label>
            <input type="email" id="createNuevoCorreo" name="correo" required />
          </div>
          <div class="form-group">
            <label for="createNuevaContrasena">Contrasena</label>
            <input
              type="password"
              id="createNuevaContrasena"
              name="contrasena"
              required
            />
          </div>
          <div class="form-group">
            <label for="createRol">Rol del Usuario</label>
            <select id="createRol" name="rol" required size="4">
              <option
                th:each="rolValue : ${rolesDisponibles}"
                th:value="${rolValue}"
                th:text="${rolValue}"
              ></option>
            </select>
          </div>
          <div
            th:if="${errorCreacion}"
            class="alert-error"
            th:text="${errorCreacion}"
          ></div>
          <div class="form-actions">
            <a th:href="@{/admin}" class="btn-cancel">Cancelar</a>
            <button type="submit" class="btn-save">Crear Usuario</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal para Crear Nueva Tarea -->
    <div class="modal-overlay" th:if="${mostrarModalCrearTarea}">
      <div class="modal-content">
        <h2>Añadir Tarea a Usuario</h2>
        <div class="section-line"></div>
        <form th:action="@{/admin/tareas/crear}" method="post" class="edit-form">
          <input
            type="hidden"
            th:name="${_csrf.parameterName}"
            th:value="${_csrf.token}"
          />
          <div class="form-group">
            <label for="usuarioParaTarea">Asignar a Usuario:</label>
            <select
              id="usuarioParaTarea"
              name="correoUsuario"
              required
              size="4"
            >
              <option
                th:each="u : ${listaDeUsuarios}"
                th:value="${u.correoElectronico}"
                th:text="${u.nombreUsuario}"
                th:selected="${preselectedUserEmail != null and u.correoElectronico == preselectedUserEmail}"
              ></option>
            </select>
          </div>
          <div
            class="section-line"
            style="margin-top: 15px; margin-bottom: 15px"
          ></div>
          <div class="form-group">
            <label for="nombreTarea">Nombre de la Tarea</label>
            <input type="text" id="nombreTarea" name="nombre" required />
          </div>
          <div class="form-group">
            <label for="descripcionTarea">Descripción</label>
            <input
              type="text"
              id="descripcionTarea"
              name="descripcion"
              required
            />
          </div>
          <div class="form-group">
            <label for="dificultadTarea">Dificultad</label>
            <select id="dificultadTarea" name="dificultad" required size="4">
              <option value="Muy fácil">Muy fácil</option>
              <option value="Fácil">Fácil</option>
              <option value="Medio">Intermedio</option>
              <option value="Difícil">Difícil</option>
              <option value="Muy difícil">Muy difícil</option>
            </select>
          </div>
          <div
            th:if="${errorCreacionTarea}"
            class="alert-error"
            th:text="${errorCreacionTarea}"
          ></div>
          <div class="form-actions">
            <a th:href="@{/admin(vista='tareas')}" class="btn-cancel"
              >Cancelar</a
            >
            <button type="submit" class="btn-save">Añadir Tarea</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal para Configuración del Top -->
    <div class="modal-overlay" th:if="${mostrarModalTopConfig}">
      <div class="modal-content">
        <h2>Configuración del Top</h2>
        <div class="section-line"></div>

        <div
          th:if="${errorConfig}"
          class="alert-error"
          th:text="${errorConfig}"
        ></div>
        <div
          th:if="${success}"
          class="alert-success"
          th:text="${success}"
        ></div>

        <div class="form-group" style="margin-top: 15px">
          <label>Mostrar Top:</label>
          <div class="top-n-buttons">
            <a
              th:href="@{/admin/top/set-limite(limite=10)}"
              class="btn-cancel"
              th:classappend="${limiteActual == 10 ? 'active' : ''}"
              >10</a
            >
            <a
              th:href="@{/admin/top/set-limite(limite=20)}"
              class="btn-cancel"
              th:classappend="${limiteActual == 20 ? 'active' : ''}"
              >20</a
            >
            <a
              th:href="@{/admin/top/set-limite(limite=30)}"
              class="btn-cancel"
              th:classappend="${limiteActual == 30 ? 'active' : ''}"
              >30</a
            >
            <a
              th:href="@{/admin/top/set-limite(limite=50)}"
              class="btn-cancel"
              th:classappend="${limiteActual == 50 ? 'active' : ''}"
              >50</a
            >
          </div>
        </div>

        <div
          class="section-line"
          style="margin-top: 25px; margin-bottom: 25px"
        ></div>

        <form th:action="@{/admin/ligas/guardar}" method="post" class="edit-form">
          <input
            type="hidden"
            th:name="${_csrf.parameterName}"
            th:value="${_csrf.token}"
          />
          <input type="hidden" name="limiteActual" th:value="${limiteActual}" />

          <label>Configuración de Ligas (Bronce es 0 Pts):</label>

          <div class="form-group-grid">
            <div class="form-group">
              <label
                for="limitePlata"
                style="font-weight: normal; font-size: 0.9em"
                >Plata &ge;</label
              >
              <input
                type="number"
                min="1"
                id="limitePlata"
                name="limitePlata"
                th:value="${limitesLiga.LIGA_PLATA}"
                required
              />
            </div>
            <div class="form-group">
              <label
                for="limiteOro"
                style="font-weight: normal; font-size: 0.9em"
                >Oro &ge;</label
              >
              <input
                type="number"
                min="1"
                id="limiteOro"
                name="limiteOro"
                th:value="${limitesLiga.LIGA_ORO}"
                required
              />
            </div>
            <div class="form-group">
              <label
                for="limitePlatino"
                style="font-weight: normal; font-size: 0.9em"
                >Platino &ge;</label
              >
              <input
                type="number"
                min="1"
                id="limitePlatino"
                name="limitePlatino"
                th:value="${limitesLiga.LIGA_PLATINO}"
                required
              />
            </div>
            <div class="form-group">
              <label
                for="limiteDiamante"
                style="font-weight: normal; font-size: 0.9em"
                >Diamante &ge;</label
              >
              <input
                type="number"
                min="1"
                id="limiteDiamante"
                name="limiteDiamante"
                th:value="${limitesLiga.LIGA_DIAMANTE}"
                required
              />
            </div>
          </div>
          <button
            type="submit"
            class="btn-save"
            style="margin-top: 15px; width: 100%"
          >
            Guardar Límites de Liga
          </button>
        </form>

        <div
          class="section-line"
          style="margin-top: 25px; margin-bottom: 25px"
        ></div>

          <div class="form-group">
          <label>Mantenimiento de Temporada:</label>
          <a
            th:href="@{/admin/temporada/reset-manual}"
            class="btn-delete"
            onclick="return confirm('¿Estás seguro de que quieres resetear TODOS los puntos de liga a 0?');"
          >
            <i class="bx bx-error-alt"></i> Forzar Reseteo de Temporada
          </a>
        </div>

        <div class="form-actions" style="margin-top: 30px">
          <a
            th:href="@{/admin(vista='top', limite=${limiteActual})}"
            class="btn-cancel"
            >Cerrar</a
          >
        </div>
      </div>
    </div>

    <!-- Modal para Editar Logro -->
    <div class="modal-overlay" th:if="${logroParaEditar != null}">
      <div class="modal-content">
        <h2>Editar Logro</h2>
        <div class="section-line"></div>
        
        <form th:action="@{/admin/logros/guardar}" method="post" class="edit-form">
          <input
            type="hidden"
            th:name="${_csrf.parameterName}"
            th:value="${_csrf.token}"
          />
          <input
            type="hidden"
            name="id"
            th:value="${logroParaEditar.id}"
          />

          <div class="form-group">
            <label for="editNombreLogro">Nombre del Logro</label>
            <input
              type="text"
              id="editNombreLogro"
              name="nombre"
              th:value="${logroParaEditar.nombre}"
              required
            />
          </div>

          <div class="form-group">
            <label for="editDescripcionLogro">Descripción</label>
            <textarea
              id="editDescripcionLogro"
              name="descripcion"
              rows="3"
              style="resize: vertical; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; font-family: 'Poppins', sans-serif;"
              th:text="${logroParaEditar.descripcion}"
              required
            ></textarea>
          </div>

          <div class="form-group">
            <label for="editImagenUrlLogro">URL del Ícono/Imagen</label>
            <input
              type="text"
              id="editImagenUrlLogro"
              name="imagenUrl"
              th:value="${logroParaEditar.imagenUrl}"
              placeholder="https://ejemplo.com/imagen.png"
            />
          </div>

          <div class="form-group">
            <label for="editExperienciaLogro">Experiencia Recompensa (XP)</label>
            <input
              type="number"
              id="editExperienciaLogro"
              name="experienciaRecompensa"
              th:value="${logroParaEditar.getPuntosRecompensa()}"
              min="0"
              step="10"
              required
            />
          </div>

          <div th:if="${errorLogro}" class="alert-error" th:text="${errorLogro}"></div>

          <div class="form-actions">
            <a th:href="@{/admin(vista='logros')}" class="btn-cancel">Cancelar</a>
            <button type="submit" class="btn-save">Guardar Cambios</button>
          </div>
        </form>
      </div>
    </div>
    <!-- 
      Botón Flotante (FAB - Floating Action Button)
      Este es un botón multifuncional cuya acción cambia dependiendo de la vista actual.
    -->
    <a
      th:if="${vistaActual != 'logros'}" th:href="@{/admin(
        crearUsuario=${vistaActual == 'usuarios'},
        crearTarea=${vistaActual == 'tareas'},
        mostrarConfig=${vistaActual == 'top'},
        vista=${vistaActual},
        limite=${vistaActual == 'top' ? limiteActual : null},
        preselectUser=${vistaActual == 'tareas' && usuarioSeleccionado != null ? usuarioSeleccionado.correoElectronico : null}
    )}"
      th:title="${vistaActual == 'usuarios' ? 'Añadir Usuario' : 
                    (vistaActual == 'tareas' ? 'Añadir Tarea' : 
                    'Configurar Top')}"
      class="fab"
    >
      <i class="bx bx-plus"></i>
    </a>

    <!-- Script para gestionar la animación de carga -->
    <script th:src="@{/js/loader-main.js}"></script>
    <!-- Incluimos el fragmento de la barra de navegación inferior -->
    <div th:replace="~{fragments :: navbar}"></div>
  </body>
</html>
