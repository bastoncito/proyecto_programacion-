<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administrador</title>
    
    <!-- CSS y Librerías -->
    <link rel="stylesheet" th:href="@{/styles/admin.css}">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" th:href="@{/styles/loader.css}">
</head>
<body>
    <!--Pantalla de carga-->
    <div th:replace="~{fragments :: loadingScreen}"></div>
    <!-- Barra lateral izquierda -->
    <div class="container-task-bar">
        <div class="logo-placeholder">
            <img th:src="@{/images/logo_negro.png}" style="width:180px; height:auto;" alt="Logo">
        </div>

        <!-- Navegación principal -->
        <ul>
            <li><a th:href="@{/admin(vista='usuarios')}"><i class='bx bxs-group'></i> Usuarios</a></li>
            <li><a th:href="@{/admin(vista='tareas')}"><i class='bx bx-task'></i> Tareas</a></li>
            <li><a href="#"><i class='bx bxs-bar-chart-alt-2'></i> Top</a></li>
            <li><a href="#"><i class='bx bxs-trophy'></i> Logros</a></li>
            <li><a th:href="@{/home}"><i class='bx bxs-home'></i> Home</a></li>
        </ul>

        <form th:action="@{/logout}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit" onclick="return confirm('¿Estás seguro de que quieres cerrar la sesión?');">Cerrar Sesión</button>
        </form>
    </div>

    <!-- Contenido principal (todo lo que está a la derecha) -->
    <div class="main-content">
        
        <!-- Mensaje exito operaciones -->
        <div th:if="${success}" class="flash-success">
            <i class='bx bx-check-circle'></i>
            <span th:text="${success}"></span>
        </div>
        <!-- Tarjeta de información del usuario (arriba a la derecha) -->
        <div class="container-info">
            <div class="info-section" th:if="${usuarioActual != null}">
                <div class="user-info">
                    <p><strong th:text="${usuarioActual.nombreUsuario}">Nombre del Usuario</strong></p>
                    <p th:text="${usuarioActual.correoElectronico}">correo@ejemplo.com</p>
                    <p th:text="${usuarioActual.rol}">Rol del Usuario</p>
                </div>
                <div class="user-avatar"></div>
            </div>
        </div>

        <!-- Zona de trabajo principal (título y tabla) -->
        <div class="container-work">

            <div th:switch="${vistaActual}">
                 <!-- Caso 1: Si la vista es 'usuarios' (o por defecto) -->
                <div th:case="'usuarios'">
                    <div class="section-title">Usuarios</div>
                    <div class="section-line"></div>

                    <div class="list-box">
                        <div class="param-bar">
                            <span>Nombre</span>
                            <span>Correo</span>
                            <span>Rol</span>
                            <span>Nivel</span>
                            <span>Acciones</span>
                        </div>
                        <!-- Filas de datos (generadas dinámicamente) -->
                        <div class="user-row" th:each="usuario : ${listaDeUsuarios}">
                            <div class="user-cell" th:text="${usuario.nombreUsuario}"></div>
                            <div class="user-cell" th:text="${usuario.correoElectronico}"></div>
                            <div class="user-cell" th:text="${usuario.rol}"></div>
                            <div class="user-cell" th:text="${usuario.nivelExperiencia}"></div>
                            <div class="user-cell actions">
                                <!-- El enlace "Editar" ahora apunta a /admin con el parámetro del correo -->
                                <a th:if="${seguridadService.puedeEditar(usuarioActual, usuario)}"
                                th:href="@{/admin(editarUsuarioCorreo=${usuario.correoElectronico}, vista='usuarios')}" 
                                class="btn-edit">Editar</a>
                                <!-- El enlace "Eliminar" apunta a /admin/eliminar con el parámetro del correo -->
                                <a th:if="${seguridadService.puedeEliminar(usuarioActual, usuario)}"
                                th:href="@{/admin/eliminar(correo=${usuario.correoElectronico})}"
                                class="btn-delete"
                                onclick="return confirm('¿Estás seguro de que quieres eliminar a este usuario?');">Eliminar</a>
                            </div>
                        </div>
                        <!-- Mensaje para cuando no hay usuarios -->
                        <div th:if="${listaDeUsuarios.isEmpty()}" class="empty-list-message">
                            <p>No hay usuarios registrados.</p>
                        </div>
                    </div>
                </div>
                 <!-- Caso 2: Si la vista es 'tareas' -->
                <div th:case="'tareas'">
                    <div th:replace="~{tareas-fragment :: contenidoTareasMaestroDetalle}"></div>
                </div>
                
                


            </div>
        </div>
    </div>

    <div class="modal-overlay" th:if="${usuarioParaEditar != null}">
    
        <div class="modal-content">
            <h2>Editar Usuario</h2>
            <div class="section-line"></div>
            
            <!-- Formulario que envía los datos al endpoint /admin/guardar -->
            <form th:action="@{/admin/guardar}" method="post" class="edit-form">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            
                <!-- Campo oculto para enviar el correo original, que es el identificador -->
                <input type="hidden" name="correoElectronicoOriginal" th:value="${usuarioParaEditar.correoElectronico}">
            
                <div class="form-group">
                    <label for="nombreUsuario">Nombre de Usuario</label>
                    <input type="text" id="nombreUsuario" name="nombreUsuario" th:value="${usuarioParaEditar.nombreUsuario}" required>
                </div>
            
                <div class="form-group">
                    <label for="nuevoCorreo">Correo Electrónico</label> 
                    <input type="email" id="nuevoCorreo" name="nuevoCorreo" th:value="${usuarioParaEditar.correoElectronico}" required>
                </div>
            
                <div class="form-group">
                    <label for="rol">Rol del Usuario</label>
                    <!-- Iteramos sobre la lista 'rolesDisponibles' que preparamos en el controlador -->
                    <select id="rol" name="rol" required>
                        <option th:each="rolValue : ${rolesDisponibles}"
                            th:value="${rolValue}"
                            th:text="${rolValue}"
                            th:selected="${rolValue == usuarioParaEditar.rol}">
                        </option>
                    </select>
                </div>

                <div class="section-line" style="margin-top: 15px; margin-bottom: 15px;"></div>
            
                <div class="form-group">
                    <label for="nuevaContraseña">Nueva Contraseña (Opcional)</label>
                    <!-- 'type="password"' para que el texto no sea visible. -->
                    <input type="password" id="nuevaContraseña" name="nuevaContraseña" placeholder="Dejar en blanco para no cambiar">
                </div>

                <div class="form-group">
                    <label for="confirmarContraseña">Confirmar Nueva Contraseña</label>
                    <input type="password" id="confirmarContraseña" name="confirmarContraseña" placeholder="Repetir la nueva contraseña">
                </div>

                <!-- Mensaje de error del servidor, si lo hay (usando addFlashAttribute) -->
                <div th:if="${error}" class="alert-error" th:text="${error}"></div>
                <!-- Mensaje de éxito del servidor -->
                <div th:if="${success}" class="alert-success" th:text="${success}"></div>
            
                <div class="form-actions">
                    <a th:href="@{/admin}" class="btn-cancel">Cerrar</a>
                    <button type="submit" class="btn-save">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" th:if="${mostrarModalCrear}">
        <div class="modal-content">
            <h2>Crear Nuevo Usuario</h2>
            <div class="section-line"></div>
            
            <form th:action="@{/admin/crear}" method="post" class="edit-form">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                
                <div class="form-group">
                    <label for="nombreUsuario">Nombre de Usuario</label>
                    <input type="text" id="nombreUsuario" name="nombreUsuario" required>
                </div>
                
                <div class="form-group">
                    <label for="nuevoCorreo">Correo Electrónico</label>
                    <input type="email" id="nuevoCorreo" name="correo" required>
                </div>

                <div class="form-group">
                    <label for="nuevaContraseña">Contraseña</label>
                    <input type="password" id="nuevaContraseña" name="contraseña" required>
                </div>
                
                <div class="form-group">
                    <label for="rol">Rol del Usuario</label>
                    <select id="rol" name="rol" required>
                        <option th:each="rolValue : ${rolesDisponibles}"
                                th:value="${rolValue}"
                                th:text="${rolValue}">
                        </option>
                    </select>
                </div>
                
                <!-- Mostramos un mensaje de error si la creación falla -->
                <div th:if="${errorCreacion}" class="alert-error" th:text="${errorCreacion}"></div>
                
                <div class="form-actions">
                    <!-- El botón de cancelar simplemente recarga la página sin el parámetro -->
                    <a th:href="@{/admin}" class="btn-cancel">Cancelar</a>
                    <button type="submit" class="btn-save">Crear Usuario</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" th:if="${mostrarModalCrearTarea}">
        <div class="modal-content">
            <h2>Añadir Tarea a Usuario</h2>
            <div class="section-line"></div>
            
            <form th:action="@{/admin/tareas/crear}" method="post" class="edit-form">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                
                <div class="form-group">
                    <label for="usuarioParaTarea">Asignar a Usuario:</label>
                    <!-- Un 'select' para elegir a qué usuario asignarle la tarea -->
                    <select id="usuarioParaTarea" name="correoUsuario" required>
                        <!-- Iteramos sobre todos los usuarios para poblar el dropdown -->
                        <option th:each="u : ${listaDeUsuarios}"
                                th:value="${u.correoElectronico}"
                                th:text="${u.nombreUsuario}">
                        </option>
                    </select>
                </div>

                <div class="section-line" style="margin-top: 15px; margin-bottom: 15px;"></div>

                <div class="form-group">
                    <label for="nombreTarea">Nombre de la Tarea</label>
                    <input type="text" id="nombreTarea" name="nombre" required>
                </div>
                
                <div class="form-group">
                    <label for="descripcionTarea">Descripción</label>
                    <input type="text" id="descripcionTarea" name="descripcion" required>
                </div>
                
                <div class="form-group">
                    <label for="dificultadTarea">Dificultad</label>
                    <select id="dificultadTarea" name="dificultad" required>
                        <option value="Muy fácil">Muy fácil</option>
                        <option value="Fácil">Fácil</option>
                        <option value="Medio">Intermedio</option>
                        <option value="Difícil">Difícil</option>
                        <option value="Muy difícil">Muy difícil</option>
                    </select>
                </div>
                
                <div th:if="${errorCreacionTarea}" class="alert-error" th:text="${errorCreacionTarea}"></div>
                
                <div class="form-actions">
                    <a th:href="@{/admin(vista='tareas')}" class="btn-cancel">Cancelar</a>
                    <button type="submit" class="btn-save">Añadir Tarea</button>
                </div>
            </form>
        </div>
    </div>

    <!-- BOTÓN FLOTANTE CREAR USUARIO/TAREA  -->
    <a th:href="${vistaActual == 'usuarios' ? '/admin?crearUsuario=true' : '/admin?vista=tareas&crearTarea=true'}"
   th:title="${vistaActual == 'usuarios' ? 'Añadir Nuevo Usuario' : 'Añadir Nueva Tarea'}"
   class="fab">
        <i class='bx bx-plus'></i>
    </a>

    <!-- SCRIPT LOADER  -->
    <script>       
        //  Buscamos el elemento del loader en el DOM.
        const loader = document.getElementById('loader-wrapper');

        //  Comprobamos el sessionStorage del navegador.
        //  sessionStorage es un almacén que dura mientras la pestaña está abierta.
        //  Buscamos una "bandera" que nos diga si ya hemos mostrado el loader en esta sesión.
        if (sessionStorage.getItem('adminLoaderShown') === 'true') {
        
            //  Si la bandera existe y es 'true', significa que esta no es la primera carga.
            //  En este caso, ocultamos el loader inmediatamente, sin animaciones.
            if (loader) {
                loader.style.display = 'none';
            }

        } else {
        
            //  Si la bandera no existe, esta es la primera carga de la página (o un refresco).
            //  Aquí es donde mostramos el loader y luego lo ocultamos.
            window.addEventListener('load', function() {
                if (loader) {
                    //  Usamos un pequeño setTimeout para asegurarnos de que el loader sea visible
                    //  al menos un instante y no un simple parpadeo si la carga es muy rápida.
                    setTimeout(function() {
                        loader.style.display = 'none';
                        //  Una vez mostrado el Loader la bandera se vuelve true para no mostrarlo mas.
                        sessionStorage.setItem('adminLoaderShown', 'true');
                    }, 500); // 500ms de duración mínima
                }
            });
        }

    </script>
</body>
</html>