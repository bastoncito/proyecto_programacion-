<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administrador</title>
    
    <!-- CSS y Librerías -->
    <link rel="stylesheet" th:href="@{/admin.css}">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>
<body>
    <!-- Barra lateral izquierda -->
    <div class="container-task-bar">
        <div class="logo-placeholder">
            <img th:src="@{/logo_negro.png}" style="width:180px; height:auto;" alt="Logo">
        </div>

        <!-- Navegación principal -->
        <ul>
            <li><a th:href="@{/admin}"><i class='bx bxs-group'></i> Usuarios</a></li>
            <li><a href="#"><i class='bx bx-task'></i> Tareas</a></li>
            <li><a href="#"><i class='bx bxs-bar-chart-alt-2'></i> Top</a></li>
            <li><a href="#"><i class='bx bxs-tag'></i> Roles</a></li>
            <li><a href="#"><i class='bx bxs-id-card'></i> Administradores</a></li>
        </ul>

        <form th:action="@{/logout}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit" onclick="return confirm('¿Estás seguro de que quieres cerrar la sesión?');">Cerrar Sesión</button>
        </form>
    </div>

    <!-- Contenido principal (todo lo que está a la derecha) -->
    <div class="main-content">
        
        <!-- Tarjeta de información del usuario (arriba a la derecha) -->
        <div class="container-info">
            <div class="info-section" th:if="${usuarioActual != null}">
                <div class="user-info">
                    <p><strong th:text="${usuarioActual.nombreUsuario}">Nombre del Usuario</strong></p>
                    <p th:text="${usuarioActual.correoElectronico}">correo@ejemplo.com</p>
                    <p th:text="${usuarioActual.rol}">Rol del Usuario</p>
                </div>
                <div class="user-avatar"></div>
            </div>
        </div>

        <!-- Zona de trabajo principal (título y tabla) -->
        <div class="container-work">
            <div class="section-title">Usuarios</div>
            <div class="section-line"></div>

            <!-- Contenedor de la tabla -->
            <div class="list-box">
                <!-- Cabecera de la tabla -->
                <div class="param-bar">
                    <span>Nombre</span>
                    <span>Correo</span>
                    <span>Rol</span>
                    <span>Nivel</span>
                    <span>Acciones</span>
                </div>

                <!-- Filas de datos (generadas dinámicamente) -->
                <div class="user-row" th:each="usuario : ${listaDeUsuarios}">
                    <div class="user-cell" th:text="${usuario.nombreUsuario}"></div>
                    <div class="user-cell" th:text="${usuario.correoElectronico}"></div>
                    <div class="user-cell" th:text="${usuario.rol}"></div>
                    <div class="user-cell" th:text="${usuario.nivelExperiencia}"></div>
                    <div class="user-cell actions">
                        <!-- El enlace "Editar" ahora apunta a /admin con el parámetro del correo -->
                        <a th:if="${seguridadService.puedeEditar(usuarioActual, usuario)}"
                        th:href="@{/admin(editarUsuarioCorreo=${usuario.correoElectronico})}" 
                        class="btn-edit">Editar</a>

                        <!-- El enlace "Eliminar" apunta a /admin/eliminar con el parámetro del correo -->
                        <a th:if="${seguridadService.puedeEliminar(usuarioActual, usuario)}"
                        th:href="@{/admin/eliminar(correo=${usuario.correoElectronico})}"
                        class="btn-delete"
                        onclick="return confirm('¿Estás seguro de que quieres eliminar a este usuario?');">Eliminar</a>
                    </div>

                </div>

                <!-- Mensaje para cuando no hay usuarios -->
                <div th:if="${listaDeUsuarios.isEmpty()}" class="empty-list-message">
                    <p>No hay usuarios registrados.</p>
                </div>
            </div>
        </div>
    </div>
<div class="modal-overlay" th:if="${usuarioParaEditar != null}">
    
    <div class="modal-content">
        <h2>Editar Usuario</h2>
        <div class="section-line"></div>
        
        <!-- Formulario que envía los datos al endpoint /admin/guardar -->
        <form th:action="@{/admin/guardar}" method="post" class="edit-form">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            
            <!-- Campo oculto para enviar el correo original, que es el identificador -->
            <input type="hidden" name="correoElectronicoOriginal" th:value="${usuarioParaEditar.correoElectronico}">
            
            <div class="form-group">
                <label for="nombreUsuario">Nombre de Usuario</label>
                <input type="text" id="nombreUsuario" name="nombreUsuario" th:value="${usuarioParaEditar.nombreUsuario}" required>
            </div>
            
            <div class="form-group">
                <label for="nuevoCorreo">Correo Electrónico</label>
                <!-- Quitamos 'disabled' y añadimos el 'name' para que se envíe al servidor -->
                <input type="email" id="nuevoCorreo" name="nuevoCorreo" th:value="${usuarioParaEditar.correoElectronico}" required>
            </div>
            
            <div class="form-group">
                <label for="rol">Rol del Usuario</label>
                <!-- Iteramos sobre la lista 'rolesDisponibles' que preparamos en el controlador -->
                <select id="rol" name="rol" required>
                    <option th:each="rolValue : ${rolesDisponibles}"
                            th:value="${rolValue}"
                            th:text="${rolValue}"
                            th:selected="${rolValue == usuarioParaEditar.rol}">
                    </option>
                </select>
            </div>

            <div class="section-line" style="margin-top: 15px; margin-bottom: 15px;"></div>
            
            <div class="form-group">
                <label for="nuevaContraseña">Nueva Contraseña (Opcional)</label>
                <!-- 'type="password"' para que el texto no sea visible. -->
                <input type="password" id="nuevaContraseña" name="nuevaContraseña" placeholder="Dejar en blanco para no cambiar">
            </div>

            <div class="form-group">
                <label for="confirmarContraseña">Confirmar Nueva Contraseña</label>
                <input type="password" id="confirmarContraseña" name="confirmarContraseña" placeholder="Repetir la nueva contraseña">
            </div>

            <!-- Mensaje de error del servidor, si lo hay (usando addFlashAttribute) -->
            <div th:if="${error}" class="alert-error" th:text="${error}"></div>
             <!-- Mensaje de éxito del servidor -->
            <div th:if="${success}" class="alert-success" th:text="${success}"></div>
            
            <div class="form-actions">
                <a th:href="@{/admin}" class="btn-cancel">Cerrar</a>
                <button type="submit" class="btn-save">Guardar Cambios</button>
            </div>
            </form>
        </div>
    </div>
</body>
</html>