<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Good Time - Home</title>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" th:href="@{/styles/home.css}">
    <link rel="stylesheet" th:href="@{/styles/loader.css}">
</head>
<body>
    <!--Pantalla de carga-->
    <div th:replace="~{fragments :: loadingScreen}"></div>

    <!-- ===== CONTENEDOR SUPERIOR IZQUIERDO (60% ancho) ===== -->
    <div class="container-advertisements">
        <div class="reto-section">
            <div class="reto-header"><h1>DESAFÍO SEMANAL</h1></div>
            <div class="reto-body">
                <p>Título</p>
                <p>Descripción de la tarea semanal...</p>
                <p>Puntaje: 500 XP</p>
                <button class="reto-button">Aceptar Desafío</button>
            </div>
        </div>
        <div class="top-section">
            <div class="top-header"><h1>TOP GLOBALES</h1></div>
            <div class="top-body">
                <div class="top-user"><div class="top-position">1</div><div class="top-user-icon"><i class='bx bx-user'></i></div><div class="top-user-name">User 1</div><div class="top-user-points">X Puntos</div></div>
                <div class="top-user"><div class="top-position">2</div><div class="top-user-icon"><i class='bx bx-user'></i></div><div class="top-user-name">User 2</div><div class="top-user-points">Y Puntos</div></div>
                <div class="top-user"><div class="top-position">3</div><div class="top-user-icon"><i class='bx bx-user'></i></div><div class="top-user-name">User 3</div><div class="top-user-points">Z Puntos</div></div>
            </div>
        </div>
    </div>

    <!-- ===== CONTENEDOR SUPERIOR DERECHO (40% ancho) ===== -->
    <div class="container-info">
        <div class="info-left">
            <div class="info-section">
                <div class="user-profile-top">
                    <div class="user-top"><p th:text="${usuario.nivelExperiencia}"></p></div>
                    <div class="user-info">
                        <strong><p th:text="${usuario.nombreUsuario}" class="username"></p></strong>
                        <p th:text="${usuario.correoElectronico}"></p>
                    </div>
                    <div class="user-avatar"></div>
                </div>
                <div class="streak-section">
                    <h1 class="streak-title">Racha Actual</h1>
                    <div class="streak-line"></div>
                    <div class="streak-content">
                        <strong><p th:text="${usuario.racha}" class="streakDays"></p></strong>
                        <i class='bx bxs-hot streak-icon'></i>
                    </div>
                </div>
                <div class="info-buttons">
                    <form th:action="@{/perfil}" method="get"><button type="submit" class="logout">Ver Perfil</button></form>
                    <form th:action="@{/logout}" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <button type="submit" class="borrar" onclick="return confirm('¿Estás seguro de que quieres cerrar la sesión?');">Cerrar Sesión</button>
                    </form>
                </div>
            </div>
            <div class="clima-section">
                 <div th:if="${clima}">
                    <div class="clima-hora"><p th:text="${clima.hora}">12:30</p></div>
                    <div class="clima-main-content">
                        <div class="clima-icon">
                            <i th:classappend="${ #strings.startsWith(clima.icono, '01') ? 'bx-sun' : #strings.startsWith(clima.icono, '02') ? 'bx-cloud' : #strings.startsWith(clima.icono, '03') or #strings.startsWith(clima.icono, '04') ? 'bxs-cloud' : #strings.startsWith(clima.icono, '09') or #strings.startsWith(clima.icono, '10') ? 'bx-cloud-rain' : #strings.startsWith(clima.icono, '11') ? 'bx-cloud-lightning' : #strings.startsWith(clima.icono, '13') ? 'bx-cloud-snow' : 'bx-question-mark' }" class='bx'></i>
                        </div>
                        <div class="clima-info">
                            <p th:text="${clima.temperatura} + '°C'">15°C</p>
                            <p th:text="'Humedad: ' + ${clima.humedad} + '%'">Humedad: 75%</p>
                        </div>
                    </div>
                    <div class="clima-status"><h2 th:text="${#strings.capitalize(clima.descripcion)}">Lluvioso</h2></div>
                </div>
                <div th:unless="${clima}" style="display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; height: 100%;">
                    <p th:if="${climaError}" th:text="${climaError}" style="color: red;"></p>
                    <p th:unless="${climaError}">
                        <a th:href="@{/perfil}" style="font-weight: bold; color: #333;">Configura tu ciudad</a>
                         para ver el clima.</p>
                </div>
            </div>
        </div>
        <div class="info-right">
            <div class="copa-section">
                <p>x Puntos</p>
                <img th:src="@{/images/copa.png}" alt="copa">
                <p>x Liga</p>
            </div>
            <div class="logo-section">
                <img th:src="@{/images/logo_negro.png}" alt="logo_negro">
            </div>
        </div>
    </div>

    <!-- ===== CONTENEDOR INFERIOR IZQUIERDO (60% ancho) ===== -->
    <div class="container-task">
        <div class="task-section">
            <div class="task-header"><h1>Tareas Pendientes</h1></div>
            <div class="task-list">
                <button class="task-item open-modal" th:each="tarea, stat : ${tareas}" th:if="${stat.index < 4}"
                        th:text="${tarea.nombre}"
                        th:attr="data-nombre=${tarea.nombre}, data-descripcion=${tarea.descripcion}, data-experiencia=${tarea.exp}, data-expira=${#temporals.format(tarea.fechaExpiracion, 'dd/MM/yyyy')}">
                </button>
                <p th:if="${#lists.isEmpty(tareas)}">No tienes tareas anotadas.</p>
            </div>
            <div class="task-buttons">
                <a th:href="@{/nueva-tarea}">Agregar Tarea</a>
            </div>
        </div>
    </div>
    
    <!-- ===== CONTENEDOR INFERIOR DERECHO (40% ancho) ===== -->
    <div class="container-history">
        <h2>Historial de Tareas</h2>
        <div class="view-section">
            <div class="param-bar">
                <span>Nombre</span>
                <span>Experiencia</span>
                <span>Fecha Finalización</span>
            </div>
            <div th:if="${#lists.isEmpty(historialTareas)}" class="history-empty">
                <p>Aún no has completado ninguna tarea.</p>
            </div>
            <div th:unless="${#lists.isEmpty(historialTareas)}" class="history-list">
                <div class="history-row" th:each="tarea, stat : ${historialTareas}" th:if="${stat.index < 3}">
                    <span th:text="${tarea.nombre}"></span>
                    <span th:text="${tarea.exp} + ' XP'" class="exp-points"></span>
                    <span th:text="${#temporals.format(tarea.fechaCompletada, 'dd/MM/yyyy HH:mm')}"></span>
                </div>
            </div>
            <div class="more-section" th:if="${#lists.size(historialTareas) > 3}">
                <a th:href="@{/historial}" class="btn-show-all">Mostrar Todo</a>
            </div>
        </div>
    </div>

    <!-- Modal de Tareas -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <button class="close-btn" id="closeModal">X</button>
            <h2 id="modalTitle"></h2>
            <p><strong>Descripcion:</strong> <span id="modalDescription"></span></p>
            <p><strong>Vale:</strong> <span id="modalExp"></span></p>
            <p><strong>Expira:</strong> <span id="modalExpire"></span></p>
            <button id="deleteButton">Eliminar Tarea</button>
            <form id="deleteForm" th:action="@{/eliminar-tarea}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <input type="hidden" name="nombreTarea" id="deleteTaskId">
            </form>
            <button id="completeButton" class="">Marcar como completada</button> 
            <form id="completeForm" th:action="@{/completar-tarea}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <input type="hidden" name="nombreTarea" id="completeTaskId">
            </form>
        </div>
    </div>

    <script>
        const modal = document.getElementById("taskModal");
        const openButtons = document.querySelectorAll(".open-modal");
        const modalTitle = document.getElementById("modalTitle");
        const modalDescription = document.getElementById("modalDescription");
        const modalExp = document.getElementById("modalExp");
        const modalExpire = document.getElementById("modalExpire");
        const closeModal = document.getElementById("closeModal");

        const deleteTaskId = document.getElementById("deleteTaskId");
        const deleteForm = document.getElementById("deleteForm");

        const completeTaskId = document.getElementById("completeTaskId");
        const completeForm = document.getElementById("completeForm");

        document.getElementById("deleteButton").addEventListener("click", () => {
            deleteTaskId.value = modalTitle.textContent;
            deleteForm.submit();
        });

         document.getElementById("completeButton").addEventListener("click", () => {
            completeTaskId.value = modalTitle.textContent;
            completeForm.submit();
        });

        // Show modal with task info
        openButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                modalTitle.textContent = btn.dataset.nombre;
                modalDescription.textContent = btn.dataset.descripcion;
                modalExp.textContent = btn.dataset.experiencia + " XP";
                modalExpire.textContent = btn.dataset.expira;
                modal.style.display = "flex";
            });
        });

        // Close modal
        closeModal.addEventListener("click", () => {
            modal.style.display = "none";
        });
    </script>
    <script>
        window.onload = function() {
            const loader = document.getElementById('loader-wrapper');
            setTimeout(function() {
                loader.style.display = 'none';
            }, 1420); 
        };
    </script>
</body>
</html>